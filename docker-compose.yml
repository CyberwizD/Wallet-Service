version: "3.9"
services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: wallet
    ports: 
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d wallet"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

  api:
    build: .
    image: wallet-service:latest
    depends_on: 
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      PORT: ${PORT:-8080}
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:?GOOGLE_CLIENT_ID is required}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:?GOOGLE_CLIENT_SECRET is required}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:?GOOGLE_REDIRECT_URL is required}
      PAYSTACK_SECRET_KEY: ${PAYSTACK_SECRET_KEY:?PAYSTACK_SECRET_KEY is required}
      PAYSTACK_WEBHOOK_SECRET: ${PAYSTACK_WEBHOOK_SECRET:?PAYSTACK_WEBHOOK_SECRET is required}
    ports: 
      - "8080:8080"

networks:
  default:
    driver: bridge
